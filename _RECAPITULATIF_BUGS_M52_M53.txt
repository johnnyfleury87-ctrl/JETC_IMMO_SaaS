================================================================================
üìä R√âCAPITULATIF COMPLET - BUG "user_id does not exist"
================================================================================

Date: 8 janvier 2026
Impact: Assignation technicien BLOQU√âE en production

================================================================================
üéØ DIAGNOSTIC FINAL
================================================================================

ERREUR EN PROD:
  column "user_id" does not exist

INVESTIGATION:
  Deux bugs trouv√©s (mais un seul bloquant en PROD)

================================================================================
üêõ BUG #1 - CRITIQUE (BLOQUANT EN PROD)
================================================================================

SOURCE: Fonction trigger notify_technicien_assignment
FICHIER SCH√âMA: supabase/schema/16_messagerie.sql (lignes 360-410)
TRIGGERS: technicien_assignment_notification, trigger_mission_technicien_assignment

PROBL√àME:
  La fonction se d√©clenche automatiquement lors de l'UPDATE de missions.technicien_id
  Elle contient 2 bugs:

  BUG 1.1 - Ligne 372:
    ‚ùå SELECT user_id, nom FROM techniciens WHERE id = NEW.technicien_id
    ‚úÖ DOIT √äTRE: SELECT profile_id, nom FROM techniciens

  BUG 1.2 - Ligne 378:
    ‚ùå v_mission_ref := NEW.reference
    ‚úÖ DOIT √äTRE: SELECT t.reference FROM tickets t WHERE t.id = NEW.ticket_id

IMPACT:
  üö® BLOQUE l'assignation technicien en PROD
  L'UPDATE sur missions.technicien_id d√©clenche le trigger qui √©choue

CORRECTION:
  ‚úÖ Migration M53 cr√©√©e
  üìÑ Fichier PROD: _APPLY_M53_PROD_URGENT.sql
  ‚è±Ô∏è Application: 30 secondes

================================================================================
üêõ BUG #2 - SECONDAIRE (NON BLOQUANT)
================================================================================

SOURCE: RPC assign_technicien_to_mission
FICHIER: supabase/migrations/20260107000100_m51_create_assign_technicien_rpc.sql
LIGNE: 125-141 (INSERT INTO notifications)

PROBL√àME:
  La RPC utilise des mauvais noms de colonnes pour l'INSERT notifications:

  ‚ùå titre        ‚Üí ‚úÖ title
  ‚ùå mission_id   ‚Üí ‚úÖ related_mission_id
  ‚ùå ticket_id    ‚Üí ‚úÖ related_ticket_id

IMPACT:
  ‚ö™ NON bloquant en PROD (car le bug #1 emp√™che d'arriver jusque-l√†)
  Mais causerait une erreur apr√®s correction du bug #1 si non corrig√©

CORRECTION:
  ‚úÖ Migration M52 cr√©√©e
  üìÑ Fichier PROD: _APPLY_M52_MANUAL.sql
  ‚è±Ô∏è Application: Optionnelle (recommand√©e)

================================================================================
üìã ORDRE D'APPLICATION RECOMMAND√â
================================================================================

√âTAPE 1 - CRITIQUE (OBLIGATOIRE):
  ‚úÖ Appliquer M53 (corrige le trigger)
  üìÑ Fichier: _APPLY_M53_PROD_URGENT.sql
  üîó URL: https://supabase.com/dashboard/project/bwzyajsrmfhrxdmfpyqy/sql
  
  R√©sultat: Assignation technicien d√©bloqu√©e

√âTAPE 2 - OPTIONNELLE (RECOMMAND√âE):
  ‚ö™ Appliquer M52 (corrige la RPC)
  üìÑ Fichier: _APPLY_M52_MANUAL.sql
  
  R√©sultat: √âvite erreur future dans la notification RPC

================================================================================
üìÅ FICHIERS CR√â√âS
================================================================================

MIGRATIONS PROD (√Ä APPLIQUER):
  üö® _APPLY_M53_PROD_URGENT.sql                    (CRITIQUE - Bug trigger)
  ‚ö™ _APPLY_M52_MANUAL.sql                          (Optionnel - Bug RPC)

MIGRATIONS COMPL√àTES:
  üìÑ 20260108000100_m53_fix_notify_technicien_assignment.sql
  üìÑ 20260108000000_m52_fix_assign_technicien_notifications.sql

DOCUMENTATION:
  üìñ _ACTION_IMMEDIATE_M53.txt                     (Guide rapide M53)
  üìñ _FIX_URGENT_M53_PROD.txt                      (Doc compl√®te M53)
  üìñ _ACTION_IMMEDIATE_FIX_M52.md                  (Guide rapide M52)
  üìñ _README_FIX_M53_URGENT.txt                    (R√©capitulatif)
  üìñ _RESOLUTION_BUG_USER_ID.md                    (Doc technique compl√®te)
  üìñ _RECAPITULATIF_BUGS_M52_M53.txt               (Ce fichier)

SCRIPTS:
  üîß _check_m48_prod.js                            (V√©rifie si M48 appliqu√©e)
  üîß _get_notify_technicien_def.js                 (R√©cup√®re d√©finition fonction)
  üîß _audit_bug_user_id.js                         (Audit complet)
  üîß _verify_m52_fix.js                            (V√©rifie M52)

================================================================================
üß™ TESTS POST-APPLICATION
================================================================================

APR√àS M53:
  1. Se connecter en tant qu'entreprise
  2. Ouvrir une mission en statut "en_attente"
  3. Assigner un technicien
  4. ‚úÖ DOIT R√âUSSIR sans erreur

V√âRIFIER LA NOTIFICATION:
  SELECT * FROM notifications 
  WHERE type = 'mission_assigned' 
  ORDER BY created_at DESC 
  LIMIT 1;
  
  ‚úÖ Devrait voir une notification avec le bon user_id

================================================================================
üîê S√âCURIT√â
================================================================================

‚úÖ Aucune nouvelle colonne cr√©√©e
‚úÖ Utilise les colonnes existantes correctement
‚úÖ Pas de hack ou fallback
‚úÖ Triggers recr√©√©s proprement
‚úÖ SECURITY DEFINER maintenu sur les fonctions
‚úÖ Aucun impact sur autres workflows

WORKFLOWS NON AFFECT√âS:
  ‚úÖ Cr√©ation mission
  ‚úÖ D√©marrer mission
  ‚úÖ Vue technicien
  ‚úÖ Vue admin
  ‚úÖ Vue locataire
  ‚úÖ Vue r√©gie

================================================================================
üìä R√âSULTAT ATTENDU
================================================================================

AVANT M53:
  Dashboard Entreprise > Mission > Assigner technicien
  ‚ùå Erreur: "column user_id does not exist"
  ‚ùå Workflow bloqu√©
  ‚ùå Lancement pilote impossible

APR√àS M53:
  Dashboard Entreprise > Mission > Assigner technicien
  ‚úÖ Assignation r√©ussie
  ‚úÖ Trigger notify_technicien_assignment s'ex√©cute
  ‚úÖ Notification cr√©√©e pour le technicien
  ‚úÖ Message syst√®me cr√©√©
  ‚úÖ Workflow complet fonctionnel
  ‚úÖ Lancement pilote d√©bloqu√©

APR√àS M53 + M52:
  ‚úÖ Tout ce qui pr√©c√®de
  ‚úÖ Notification RPC correcte (si on rappelle la RPC)
  ‚úÖ 100% fonctionnel sans risque d'erreur future

================================================================================
‚ö†Ô∏è IMPORTANT - POURQUOI M48 N'A PAS SUFFI
================================================================================

M48 contenait d√©j√† le fix de notify_technicien_assignment.

MAIS:
  - Soit M48 n'a jamais √©t√© appliqu√©e en PROD
  - Soit le sch√©ma de base (16_messagerie.sql) a √©cras√© la fonction

M53 = R√©application du fix de M48 pour √™tre s√ªr.

Pour v√©rifier si M48 est en PROD:
  node _check_m48_prod.js

================================================================================
‚úÖ CONCLUSION
================================================================================

BUG CRITIQUE: notify_technicien_assignment utilise des colonnes inexistantes
CORRECTION: M53 recr√©e la fonction avec les bonnes colonnes
APPLICATION: 30 secondes via Dashboard Supabase
IMPACT: D√©bloque l'assignation technicien
URGENCE: CRITIQUE (bloquant lancement pilote)

PROCHAINE √âTAPE:
  Appliquer _APPLY_M53_PROD_URGENT.sql imm√©diatement

================================================================================
