================================================================================
ğŸš¨ FIX URGENT PROD - ASSIGNATION TECHNICIEN
================================================================================

ğŸ“… 8 janvier 2026
ğŸ¯ Bug identifiÃ©: column "user_id" does not exist
ğŸ“ Source rÃ©elle: Fonction trigger notify_technicien_assignment

================================================================================
ğŸ” DIAGNOSTIC CORRECT
================================================================================

âŒ ERREUR EN PROD:
   Lors de l'assignation technicien â†’ column "user_id" does not exist

âœ… SOURCE IDENTIFIÃ‰E:
   - Table: public.missions
   - Triggers: technicien_assignment_notification, trigger_mission_technicien_assignment
   - Fonction: public.notify_technicien_assignment (OID 41819)

ğŸ› BUGS DANS LA FONCTION:
   
   1. Ligne 372: SELECT user_id, nom FROM techniciens
      âŒ La colonne user_id N'EXISTE PAS dans techniciens
      âœ… Doit Ãªtre: SELECT profile_id, nom FROM techniciens
   
   2. Ligne 378: v_mission_ref := NEW.reference
      âŒ La colonne reference N'EXISTE PAS dans missions
      âœ… Doit rÃ©cupÃ©rer tickets.reference via JOIN

================================================================================
ğŸš€ APPLICATION IMMÃ‰DIATE (30 SECONDES)
================================================================================

Ã‰TAPE 1: Ouvrir SQL Editor Supabase
ğŸ‘‰ https://supabase.com/dashboard/project/bwzyajsrmfhrxdmfpyqy/sql

Ã‰TAPE 2: Copier le fichier
ğŸ“„ supabase/migrations/_APPLY_M53_PROD_URGENT.sql

Ã‰TAPE 3: Coller et exÃ©cuter
1. Coller tout le contenu dans l'Ã©diteur
2. Cliquer "RUN"
3. âœ… Devrait voir "Success"

================================================================================
âœ… CORRECTION APPLIQUÃ‰E
================================================================================

CHANGEMENTS:
âœ… techniciens.user_id â†’ techniciens.profile_id
âœ… missions.reference â†’ tickets.reference (via JOIN)
âœ… Trigger recrÃ©Ã©

IMPACT:
âœ… Assignation technicien â†’ DÃ‰BLOQUÃ‰
âœ… Notifications crÃ©Ã©es correctement
âœ… Aucun impact sur autres workflows

================================================================================
ğŸ§ª TEST APRÃˆS APPLICATION
================================================================================

1. Se connecter en tant qu'entreprise
2. Ouvrir une mission en statut "en_attente"
3. Assigner un technicien
4. âœ… DOIT RÃ‰USSIR sans erreur

VÃ©rifier la notification:
SELECT * FROM notifications 
WHERE type = 'mission_assigned' 
ORDER BY created_at DESC 
LIMIT 1;

âœ… Devrait voir une notification avec le bon user_id

================================================================================
ğŸ“ FICHIERS
================================================================================

Migration principale:
- supabase/migrations/20260108000100_m53_fix_notify_technicien_assignment.sql

Version PROD urgente:
- supabase/migrations/_APPLY_M53_PROD_URGENT.sql  ğŸ‘ˆ UTILISER CELLE-CI

================================================================================
âš ï¸ IMPORTANT
================================================================================

C'est LE VRAI BUG (pas la RPC assign_technicien_to_mission).

Le problÃ¨me vient du TRIGGER qui se dÃ©clenche automatiquement lors de 
l'UPDATE de missions.technicien_id.

La fonction trigger utilisait des colonnes qui n'existent pas:
- techniciens.user_id (c'est profile_id)
- missions.reference (doit rÃ©cupÃ©rer tickets.reference)

Cette correction est CRITIQUE pour dÃ©bloquer l'assignation technicien.

================================================================================
