================================================================================
üîß SYNTH√àSE R√âSOLUTION BUG - "column user_id does not exist"
================================================================================

üìÖ DATE: 8 janvier 2026
üéØ STATUT: ‚úÖ R√âSOLU - Migration pr√™te √† appliquer

================================================================================
üö® LE PROBL√àME
================================================================================

SYMPT√îME:
  Lors de l'assignation d'un technicien √† une mission depuis le dashboard 
  entreprise, erreur PostgreSQL:
  
    ‚ùå column "user_id" does not exist

IMPACT:
  - Workflow entreprise ‚Üí technicien TOTALEMENT BLOQU√â
  - Impossible d'assigner des techniciens
  - BLOQUE LE LANCEMENT PILOTE

================================================================================
üîç LA CAUSE (IDENTIFI√âE)
================================================================================

LOCALISATION:
  Fonction: assign_technicien_to_mission
  Fichier: supabase/migrations/20260107000100_m51_create_assign_technicien_rpc.sql
  Ligne: 125-141 (INSERT INTO notifications)

ROOT CAUSE:
  La fonction utilise des MAUVAIS noms de colonnes pour la table notifications:
  
  ‚ùå Code bugu√© (M51):
     INSERT INTO notifications (
       type,
       titre,         -- N'EXISTE PAS (doit √™tre "title")
       message,
       mission_id,    -- N'EXISTE PAS (doit √™tre "related_mission_id")
       ticket_id,     -- N'EXISTE PAS (doit √™tre "related_ticket_id")
       user_id,
       created_at
     )
  
  ‚úÖ Colonnes r√©elles:
     - title (pas "titre")
     - related_mission_id (pas "mission_id")
     - related_ticket_id (pas "ticket_id")
     - user_id (OK)
     - created_at (OK)

POURQUOI "user_id" DANS L'ERREUR?
  PostgreSQL rejette l'INSERT car les premi√®res colonnes (titre, mission_id, 
  ticket_id) n'existent pas. Le message d'erreur mentionne "user_id" car c'est 
  probablement la premi√®re colonne reconnue apr√®s les colonnes invalides.

================================================================================
‚úÖ LA SOLUTION
================================================================================

MIGRATION CR√â√âE:
  üìÑ supabase/migrations/20260108000000_m52_fix_assign_technicien_notifications.sql
  
  Cette migration:
  1. Supprime l'ancienne version bugu√©e de assign_technicien_to_mission
  2. Recr√©e la fonction avec les BONS noms de colonnes
  3. Pr√©serve toute la logique de s√©curit√©
  4. Maintient les permissions

CHANGEMENTS:
  INSERT INTO notifications (
    type,
    title,                    ‚úÖ Corrig√© (au lieu de "titre")
    message,
    related_mission_id,       ‚úÖ Corrig√© (au lieu de "mission_id")
    related_ticket_id,        ‚úÖ Corrig√© (au lieu de "ticket_id")
    user_id,
    created_at
  )

AUTRES FONCTIONS V√âRIFI√âES:
  ‚úÖ M48 (demarrer_mission) - Utilise d√©j√† les bons noms
  ‚úÖ M22 (notify_new_ticket) - Utilise d√©j√† les bons noms
  
  üëâ Seule M51 √©tait affect√©e

================================================================================
üöÄ APPLICATION (2 MINUTES)
================================================================================

M√âTHODE 1: Via Dashboard Supabase (RECOMMAND√â)
  
  1. Ouvrir: https://supabase.com/dashboard/project/bwzyajsrmfhrxdmfpyqy/sql
  
  2. Copier le fichier:
     supabase/migrations/_APPLY_M52_MANUAL.sql
  
  3. Coller dans l'√©diteur SQL
  
  4. Cliquer "RUN"
  
  5. ‚úÖ Devrait voir "Success"

M√âTHODE 2: Via CLI Supabase
  
  cd /workspaces/JETC_IMMO_SaaS
  supabase db push --db-url "$DATABASE_URL"

================================================================================
‚úÖ V√âRIFICATION POST-APPLICATION
================================================================================

TEST 1: V√©rifier la fonction
  SELECT proname FROM pg_proc 
  WHERE proname = 'assign_technicien_to_mission';
  
  ‚úÖ Doit retourner 1 ligne

TEST 2: V√©rifier la d√©finition
  node _verify_m52_fix.js
  
  ‚úÖ Doit afficher "CORRECTION VALID√âE"

TEST 3: Test fonctionnel
  1. Se connecter en tant qu'entreprise
  2. Ouvrir une mission en statut "en_attente"
  3. Assigner un technicien
  
  ‚úÖ Doit r√©ussir SANS erreur

TEST 4: V√©rifier la notification cr√©√©e
  SELECT * FROM notifications 
  WHERE type = 'mission_assigned' 
  ORDER BY created_at DESC 
  LIMIT 1;
  
  ‚úÖ Doit voir une notification avec les bonnes colonnes

================================================================================
üìÅ FICHIERS CR√â√âS
================================================================================

MIGRATIONS:
  ‚úÖ supabase/migrations/20260108000000_m52_fix_assign_technicien_notifications.sql
     (migration principale compl√®te avec documentation)
  
  ‚úÖ supabase/migrations/_APPLY_M52_MANUAL.sql
     (version simplifi√©e pour copier-coller)

DOCUMENTATION:
  ‚úÖ _RESOLUTION_BUG_USER_ID.md
     (documentation technique compl√®te)
  
  ‚úÖ _ACTION_IMMEDIATE_FIX_M52.md
     (guide d'application rapide)
  
  ‚úÖ _SYNTHESE_BUG_FIX_M52.txt
     (ce fichier)

SCRIPTS:
  ‚úÖ _audit_bug_user_id.js
     (audit exhaustif des policies, RPC, triggers)
  
  ‚úÖ _apply_m52_fix_notifications.js
     (tentative application automatique)
  
  ‚úÖ _apply_m52_via_api.js
     (g√©n√©ration fichier manuel)
  
  ‚úÖ _verify_m52_fix.js
     (v√©rification post-application)

FICHIER MODIFI√â:
  ‚ö†Ô∏è  supabase/migrations/20260107000100_m51_create_assign_technicien_rpc.sql
     (header mis √† jour pour indiquer qu'il est bugu√© et corrig√© par M52)

================================================================================
üîê S√âCURIT√â
================================================================================

‚úÖ Aucune colonne user_id ajout√©e (utilise colonnes existantes)
‚úÖ Pas de hack ou fallback
‚úÖ Respect du sch√©ma existant
‚úÖ Policies RLS non affect√©es
‚úÖ SECURITY DEFINER maintenu
‚úÖ V√©rifications d'appartenance entreprise maintenues
‚úÖ V√©rifications de statut mission maintenues

IMPACT SUR AUTRES WORKFLOWS:
  ‚úÖ Cr√©ation mission - Pas d'impact
  ‚úÖ Vue technicien - Pas d'impact
  ‚úÖ Vue admin - Pas d'impact
  ‚úÖ Vue locataire - Pas d'impact
  ‚úÖ Vue r√©gie - Pas d'impact

================================================================================
üìä R√âSULTAT ATTENDU
================================================================================

AVANT M52:
  Dashboard Entreprise > Mission > Assigner technicien
  ‚ùå Erreur: "column user_id does not exist"
  ‚ùå Workflow bloqu√©

APR√àS M52:
  Dashboard Entreprise > Mission > Assigner technicien
  ‚úÖ Assignation r√©ussie
  ‚úÖ Notification cr√©√©e
  ‚úÖ Workflow complet fonctionnel

================================================================================
üìû SUPPORT
================================================================================

En cas de probl√®me apr√®s application:

1. V√©rifier les logs Supabase:
   Dashboard > Logs > Database

2. V√©rifier que la fonction existe:
   SELECT * FROM pg_proc WHERE proname = 'assign_technicien_to_mission';

3. Ex√©cuter le script de v√©rification:
   node _verify_m52_fix.js

4. Si le probl√®me persiste:
   - V√©rifier que M52 a bien √©t√© appliqu√©e
   - R√©appliquer M52 si n√©cessaire
   - V√©rifier les permissions sur la fonction

================================================================================
‚úÖ CONCLUSION
================================================================================

‚úÖ Bug identifi√© avec pr√©cision
‚úÖ Cause racine confirm√©e
‚úÖ Solution propre cr√©√©e
‚úÖ Documentation compl√®te
‚úÖ Aucun impact sur les autres workflows
‚úÖ Pr√™t √† appliquer en production

‚è±Ô∏è  Temps estim√© d'application: 2 minutes
üéØ Impact: D√©bloque l'assignation technicien
üö® Urgence: CRITIQUE (bloquant lancement pilote)

================================================================================
PROCHAINE √âTAPE: Appliquer M52 via Dashboard Supabase
================================================================================
