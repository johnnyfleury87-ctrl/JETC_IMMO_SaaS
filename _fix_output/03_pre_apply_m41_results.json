{
  "timestamp": "2026-01-04T16:42:03.014Z",
  "etape": "3 - Préparation M41",
  "checks": {
    "m05_analysis": {
      "exists": true,
      "content": "-- ============================================================\n-- MIGRATION M05 - Corriger RPC accept_ticket_and_create_mission\n-- ============================================================\n-- Date: 2025-12-26\n-- Phase: 1 (Débloquer workflow)\n-- Objectif: Corriger RPC acceptation ticket (retirer check colonne 'autorise' inexistante, ajouter logique mode_diffusion)\n-- Dépendances: M01, M02, M03, M04 (colonnes + RPCs)\n-- Rollback: 20251226170400_m05_fix_rpc_accept_ticket_rollback.sql\n-- ============================================================\n\nCREATE OR REPLACE FUNCTION accept_ticket_and_create_mission(\n  p_ticket_id uuid,\n  p_entreprise_id uuid\n) RETURNS uuid \nLANGUAGE plpgsql \nSECURITY DEFINER \nSET search_path = public\nAS $$\nDECLARE\n  v_mission_id uuid;\n  v_ticket_statut ticket_status;\n  v_mode_diffusion text;\n  v_entreprise_assignee uuid;\n  v_locked_at timestamptz;\n  v_regie_id uuid;\nBEGIN\n  -- Récupérer infos ticket\n  SELECT statut, mode_diffusion, entreprise_id, locked_at, regie_id \n  INTO v_ticket_statut, v_mode_diffusion, v_entreprise_assignee, v_locked_at, v_regie_id\n  FROM tickets \n  WHERE id = p_ticket_id;\n  \n  IF NOT FOUND THEN \n    RAISE EXCEPTION 'Ticket % non trouvé', p_ticket_id; \n  END IF;\n\n  -- Vérifier que ticket est au statut 'en_attente'\n  IF v_ticket_statut != 'en_attente' THEN\n    RAISE EXCEPTION 'Ticket doit être au statut en_attente (statut actuel: %)', v_ticket_statut;\n  END IF;\n\n  -- Vérifier que ticket n'est pas déjà verrouillé (accepté par autre entreprise)\n  IF v_locked_at IS NOT NULL THEN\n    RAISE EXCEPTION 'Ticket déjà verrouillé (accepté par une autre entreprise)';\n  END IF;\n\n  -- Validation selon mode diffusion\n  IF v_mode_diffusion = 'public' THEN\n    -- Mode public: Vérifier que entreprise est autorisée en mode 'general'\n    IF NOT EXISTS (\n      SELECT 1 FROM regies_entreprises \n      WHERE regie_id = v_regie_id \n      AND entreprise_id = p_entreprise_id \n      AND mode_diffusion = 'general'\n    ) THEN\n      RAISE EXCEPTION 'Entreprise % non autorisée pour tickets publics de régie %', p_entreprise_id, v_regie_id;\n    END IF;\n    \n  ELSIF v_mode_diffusion = 'assigné' THEN\n    -- Mode assigné: Vérifier que entreprise correspond à celle assignée\n    IF v_entreprise_assignee IS NULL THEN\n      RAISE EXCEPTION 'Ticket en mode assigné mais aucune entreprise assignée (données incohérentes)';\n    END IF;\n    IF v_entreprise_assignee != p_entreprise_id THEN\n      RAISE EXCEPTION 'Ticket assigné à une autre entreprise (assignée: %, tentée: %)', v_entreprise_assignee, p_entreprise_id;\n    END IF;\n    \n  ELSE\n    RAISE EXCEPTION 'Mode diffusion invalide ou NULL: %', COALESCE(v_mode_diffusion, 'NULL');\n  END IF;\n\n  -- Verrouiller ticket (locked_at + entreprise_id si pas déjà rempli en mode assigné)\n  UPDATE tickets \n  SET locked_at = now(),\n      entreprise_id = p_entreprise_id,\n      updated_at = now()\n  WHERE id = p_ticket_id;\n\n  -- Changer statut en_attente → en_cours via RPC\n  PERFORM update_ticket_statut(p_ticket_id, 'en_cours');\n\n  -- Créer mission (contrainte UNIQUE sur ticket_id empêche doublons)\n  INSERT INTO missions (\n    id,\n    ticket_id, \n    entreprise_id, \n    statut,\n    created_at,\n    updated_at\n  ) VALUES (\n    gen_random_uuid(),\n    p_ticket_id,\n    p_entreprise_id,\n    'en_attente',\n    now(),\n    now()\n  ) RETURNING id INTO v_mission_id;\n\n  RETURN v_mission_id;\nEND;\n$$;\n\n-- Accorder permissions\nGRANT EXECUTE ON FUNCTION accept_ticket_and_create_mission(uuid, uuid) TO authenticated;\n\n-- ============================================================\n-- VALIDATION QUERIES (à exécuter après migration)\n-- ============================================================\n\n-- VALIDATION 1: Vérifier fonction modifiée\n-- SELECT routine_name, routine_type \n-- FROM information_schema.routines \n-- WHERE routine_name = 'accept_ticket_and_create_mission';\n-- Attendu: 1 ligne (FUNCTION)\n\n-- VALIDATION 2: Vérifier signature fonction\n-- SELECT pg_catalog.pg_get_function_arguments(p.oid) AS args\n-- FROM pg_proc p WHERE p.proname = 'accept_ticket_and_create_mission';\n-- Attendu: p_ticket_id uuid, p_entreprise_id uuid\n\n-- VALIDATION 3: Test acceptation mode public (staging via API avec JWT entreprise)\n-- Pré-requis: Ticket statut='en_attente', mode_diffusion='public', entreprise autorisée 'general'\n-- API call: POST /rpc/accept_ticket_and_create_mission \n-- Body: {\"p_ticket_id\": \"<uuid>\", \"p_entreprise_id\": \"<uuid>\"}\n-- Attendu: Mission créée, ticket passe 'en_cours', locked_at rempli, HTTP 200 avec mission_id\n\n-- VALIDATION 4: Test acceptation mode assigné (staging via API)\n-- Pré-requis: Ticket mode_diffusion='assigné', entreprise_id correct\n-- API call: POST /rpc/accept_ticket_and_create_mission {...}\n-- Attendu: Mission créée, ticket passe 'en_cours', HTTP 200\n\n-- VALIDATION 5: Test acceptation déjà verrouillé (doit échouer)\n-- Pré-requis: Ticket locked_at NOT NULL\n-- API call: POST /rpc/accept_ticket_and_create_mission {...}\n-- Attendu: ERROR - Ticket déjà verrouillé\n\n-- VALIDATION 6: Test mode assigné mauvaise entreprise (doit échouer)\n-- Pré-requis: Ticket assigné à entreprise A, tentative entreprise B\n-- API call: POST /rpc/accept_ticket_and_create_mission {\"p_entreprise_id\": \"<entreprise_B>\"}\n-- Attendu: ERROR - Ticket assigné à une autre entreprise\n\n-- VALIDATION 7: Test doublon mission (doit échouer via contrainte UNIQUE)\n-- Pré-requis: Mission déjà existante pour ticket_id\n-- API call: POST /rpc/accept_ticket_and_create_mission {...}\n-- Attendu: ERROR - duplicate key value violates unique constraint\n\n-- ============================================================\n-- FIN MIGRATION M05\n-- ============================================================\n",
      "rpcDefinition": "CREATE OR REPLACE FUNCTION accept_ticket_and_create_mission(\n  p_ticket_id uuid,\n  p_entreprise_id uuid\n) RETURNS uuid \nLANGUAGE plpgsql \nSECURITY DEFINER \nSET search_path = public\nAS $$\nDECLARE\n  v_mission_id uuid;\n  v_ticket_statut ticket_status;\n  v_mode_diffusion text;\n  v_entreprise_assignee uuid;\n  v_locked_at timestamptz;\n  v_regie_id uuid;\nBEGIN\n  -- Récupérer infos ticket\n  SELECT statut, mode_diffusion, entreprise_id, locked_at, regie_id \n  INTO v_ticket_statut, v_mode_diffusion, v_entreprise_assignee, v_locked_at, v_regie_id\n  FROM tickets \n  WHERE id = p_ticket_id;\n  \n  IF NOT FOUND THEN \n    RAISE EXCEPTION 'Ticket % non trouvé', p_ticket_id; \n  END IF;\n\n  -- Vérifier que ticket est au statut 'en_attente'\n  IF v_ticket_statut != 'en_attente' THEN\n    RAISE EXCEPTION 'Ticket doit être au statut en_attente (statut actuel: %)', v_ticket_statut;\n  END IF;\n\n  -- Vérifier que ticket n'est pas déjà verrouillé (accepté par autre entreprise)\n  IF v_locked_at IS NOT NULL THEN\n    RAISE EXCEPTION 'Ticket déjà verrouillé (accepté par une autre entreprise)';\n  END IF;\n\n  -- Validation selon mode diffusion\n  IF v_mode_diffusion = 'public' THEN\n    -- Mode public: Vérifier que entreprise est autorisée en mode 'general'\n    IF NOT EXISTS (\n      SELECT 1 FROM regies_entreprises \n      WHERE regie_id = v_regie_id \n      AND entreprise_id = p_entreprise_id \n      AND mode_diffusion = 'general'\n    ) THEN\n      RAISE EXCEPTION 'Entreprise % non autorisée pour tickets publics de régie %', p_entreprise_id, v_regie_id;\n    END IF;\n    \n  ELSIF v_mode_diffusion = 'assigné' THEN\n    -- Mode assigné: Vérifier que entreprise correspond à celle assignée\n    IF v_entreprise_assignee IS NULL THEN\n      RAISE EXCEPTION 'Ticket en mode assigné mais aucune entreprise assignée (données incohérentes)';\n    END IF;\n    IF v_entreprise_assignee != p_entreprise_id THEN\n      RAISE EXCEPTION 'Ticket assigné à une autre entreprise (assignée: %, tentée: %)', v_entreprise_assignee, p_entreprise_id;\n    END IF;\n    \n  ELSE\n    RAISE EXCEPTION 'Mode diffusion invalide ou NULL: %', COALESCE(v_mode_diffusion, 'NULL');\n  END IF;\n\n  -- Verrouiller ticket (locked_at + entreprise_id si pas déjà rempli en mode assigné)\n  UPDATE tickets \n  SET locked_at = now(),\n      entreprise_id = p_entreprise_id,\n      updated_at = now()\n  WHERE id = p_ticket_id;\n\n  -- Changer statut en_attente → en_cours via RPC\n  PERFORM update_ticket_statut(p_ticket_id, 'en_cours');\n\n  -- Créer mission (contrainte UNIQUE sur ticket_id empêche doublons)\n  INSERT INTO missions (\n    id,\n    ticket_id, \n    entreprise_id, \n    statut,\n    created_at,\n    updated_at\n  ) VALUES (\n    gen_random_uuid(),\n    p_ticket_id,\n    p_entreprise_id,\n    'en_attente',\n    now(),\n    now()\n  ) RETURNING id INTO v_mission_id;\n\n  RETURN v_mission_id;\nEND;",
      "hasPublic": true,
      "hasAssigne": true,
      "hasGeneral": true,
      "hasRestreint": false
    },
    "m41_analysis": {
      "exists": true,
      "content": "-- ============================================================\n-- MIGRATION M41: Harmonisation terminologie RPC acceptation ticket\n-- ============================================================\n-- Date: 2026-01-04\n-- Auteur: Harmonisation mode_diffusion dans accept_ticket_and_create_mission\n-- Objectif: Corriger RPC pour accepter 'general'/'restreint' au lieu de 'public'/'assigné'\n-- Dépendances: M05 (RPC originale), M35 (harmonisation terminologie)\n-- Rollback: 20260104001700_m41_harmonize_rpc_acceptation_rollback.sql\n-- ============================================================\n\n-- CONTEXTE:\n-- M05 créé la RPC accept_ticket_and_create_mission qui valide mode_diffusion.\n-- Problème: Attend 'public'/'assigné' mais données sont 'general'/'restreint' (M35).\n-- Erreur: \"Mode diffusion invalide ou NULL: general\"\n-- Solution: Remplacer les checks par nouvelle terminologie.\n\nCREATE OR REPLACE FUNCTION accept_ticket_and_create_mission(\n  p_ticket_id uuid,\n  p_entreprise_id uuid,\n  p_disponibilite_id uuid DEFAULT NULL\n) RETURNS uuid \nLANGUAGE plpgsql \nSECURITY DEFINER \nSET search_path = public\nAS $$\nDECLARE\n  v_mission_id uuid;\n  v_ticket_statut ticket_status;\n  v_mode_diffusion text;\n  v_entreprise_assignee uuid;\n  v_locked_at timestamptz;\n  v_regie_id uuid;\nBEGIN\n  -- Récupérer infos ticket\n  SELECT statut, mode_diffusion, entreprise_id, locked_at, regie_id \n  INTO v_ticket_statut, v_mode_diffusion, v_entreprise_assignee, v_locked_at, v_regie_id\n  FROM tickets \n  WHERE id = p_ticket_id;\n  \n  IF NOT FOUND THEN \n    RAISE EXCEPTION 'Ticket % non trouvé', p_ticket_id; \n  END IF;\n\n  -- Vérifier que ticket est au statut 'en_attente'\n  IF v_ticket_statut != 'en_attente' THEN\n    RAISE EXCEPTION 'Ticket doit être au statut en_attente (statut actuel: %)', v_ticket_statut;\n  END IF;\n\n  -- Vérifier que ticket n'est pas déjà verrouillé (accepté par autre entreprise)\n  IF v_locked_at IS NOT NULL THEN\n    RAISE EXCEPTION 'Ticket déjà verrouillé (accepté par une autre entreprise)';\n  END IF;\n\n  -- Validation selon mode diffusion (NOUVELLE TERMINOLOGIE)\n  IF v_mode_diffusion = 'general' THEN\n    -- Mode general (marketplace): Vérifier que entreprise est autorisée\n    IF NOT EXISTS (\n      SELECT 1 FROM regies_entreprises \n      WHERE regie_id = v_regie_id \n      AND entreprise_id = p_entreprise_id \n      AND mode_diffusion = 'general'\n    ) THEN\n      RAISE EXCEPTION 'Entreprise % non autorisée pour tickets marketplace de régie %', p_entreprise_id, v_regie_id;\n    END IF;\n    \n  ELSIF v_mode_diffusion = 'restreint' THEN\n    -- Mode restreint (assignation): Vérifier que entreprise correspond\n    IF v_entreprise_assignee IS NULL THEN\n      RAISE EXCEPTION 'Ticket en mode restreint mais aucune entreprise assignée (données incohérentes)';\n    END IF;\n    IF v_entreprise_assignee != p_entreprise_id THEN\n      RAISE EXCEPTION 'Ticket assigné à une autre entreprise (assignée: %, tentée: %)', v_entreprise_assignee, p_entreprise_id;\n    END IF;\n    \n  ELSE\n    RAISE EXCEPTION 'Mode diffusion invalide ou NULL: % (attendu: general ou restreint)', COALESCE(v_mode_diffusion, 'NULL');\n  END IF;\n\n  -- Verrouiller ticket (locked_at + entreprise_id si pas déjà rempli)\n  UPDATE tickets \n  SET locked_at = now(),\n      entreprise_id = p_entreprise_id,\n      updated_at = now()\n  WHERE id = p_ticket_id;\n\n  -- Changer statut en_attente → en_cours via RPC\n  PERFORM update_ticket_statut(p_ticket_id, 'en_cours');\n\n  -- Créer mission (contrainte UNIQUE sur ticket_id empêche doublons)\n  INSERT INTO missions (\n    id,\n    ticket_id, \n    entreprise_id,\n    disponibilite_id,\n    statut,\n    created_at,\n    updated_at\n  ) VALUES (\n    gen_random_uuid(),\n    p_ticket_id,\n    p_entreprise_id,\n    p_disponibilite_id,  -- Créneau sélectionné (M42)\n    'en_attente',\n    now(),\n    now()\n  ) RETURNING id INTO v_mission_id;\n\n  RETURN v_mission_id;\nEND;\n$$;\n\n-- Commentaire mis à jour\nCOMMENT ON FUNCTION accept_ticket_and_create_mission(uuid, uuid, uuid) IS\n'Acceptation ticket par entreprise et création mission.\nValidation: mode_diffusion general (entreprise autorisée) ou restreint (assignée).\nTerminologie harmonisée M35: general/restreint.\nParamètre disponibilite_id (M41+M42): créneau sélectionné par entreprise.';\n\n-- Validation\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM pg_proc \n    WHERE proname = 'accept_ticket_and_create_mission'\n  ) THEN\n    RAISE NOTICE '✅ M41: RPC accept_ticket_and_create_mission harmonisée';\n  ELSE\n    RAISE EXCEPTION '❌ M41: Erreur lors de la mise à jour de la RPC';\n  END IF;\nEND $$;\n\n-- ============================================================\n-- FIN MIGRATION M41\n-- ============================================================\n",
      "hasGeneral": true,
      "hasRestreint": true,
      "hasPublic": true,
      "hasAssigne": true
    },
    "db_rpc": {
      "method": null,
      "success": false,
      "data": null
    },
    "m41_prepared": {
      "path": "_fix_output/03_m41_to_apply.sql",
      "lines": 135,
      "size_kb": 4.6
    }
  },
  "summary": {
    "m05_obsolete_confirmed": true,
    "m41_ready": true,
    "m41_prepared": true,
    "validation": "READY_TO_APPLY"
  }
}